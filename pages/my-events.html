<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Events - Community Events</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="dashboard.html" class="nav-brand">Community Events</a>
            <ul class="nav-links">
                <li><a href="dashboard.html">Home</a></li>
                <li><a href="my-events.html">My Events</a></li>
                <li><a href="create-event.html">Create Event</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>My Events</h1>
                <p>Manage your event registrations and created events</p>
            </div>

             <!-- Event Tabs  -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('registered')">
                    Registered Events
                </button>
                <button class="tab-button" onclick="switchTab('created')">
                    Created Events
                </button>
            </div>

             <!-- Registered Events Tab  -->
            <div id="registeredTab" class="tab-content active">
                <div class="section-header">
                    <h2>Events You're Attending</h2>
                    <div class="filter-controls">
                        <select id="statusFilter" onchange="filterRegisteredEvents()">
                            <option value="all">All Events</option>
                            <option value="upcoming">Upcoming</option>
                            <option value="past">Past Events</option>
                        </select>
                    </div>
                </div>

                <div id="registeredLoadingSpinner" class="loading">
                    Loading your registered events...
                </div>

                <div id="registeredEventsContainer" class="events-grid" style="display: none;">
                     Registered events will be populated here 
                </div>

                <div id="noRegisteredEvents" class="no-events" style="display: none;">
                    <h3>No registered events</h3>
                    <p>You haven't registered for any events yet. Browse available events to get started!</p>
                    <a href="dashboard.html" class="btn btn-primary">Browse Events</a>
                </div>
            </div>

             <!-- Created Events Tab  -->
            <div id="createdTab" class="tab-content">
                <div class="section-header">
                    <h2>Events You've Created</h2>
                    <a href="create-event.html" class="btn btn-primary">Create New Event</a>
                </div>

                <div id="createdLoadingSpinner" class="loading">
                    Loading your created events...
                </div>

                <div id="createdEventsContainer" class="events-grid" style="display: none;">
                     Created events will be populated here 
                </div>

                <div id="noCreatedEvents" class="no-events" style="display: none;">
                    <h3>No created events</h3>
                    <p>You haven't created any events yet. Start organizing your first community event!</p>
                    <a href="create-event.html" class="btn btn-primary">Create Event</a>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/events.js"></script>
    <script>
        // Ensure user is authenticated
        requireAuth();
        updateAuthUI();

        let registeredEvents = [];
        let createdEvents = [];
        let currentTab = 'registered';

        // Load events when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadRegisteredEvents();
            loadCreatedEvents();
        });

        // Switch between tabs
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Load user's registered events
        async function loadRegisteredEvents() {
            const loadingSpinner = document.getElementById('registeredLoadingSpinner');
            const eventsContainer = document.getElementById('registeredEventsContainer');
            const noEvents = document.getElementById('noRegisteredEvents');

            try {
                loadingSpinner.style.display = 'block';
                eventsContainer.style.display = 'none';
                noEvents.style.display = 'none';

                const user = getCurrentUser();
                const events = await usersAPI.getMyEvents(user.id);
                registeredEvents = events;

                if (events.length === 0) {
                    loadingSpinner.style.display = 'none';
                    noEvents.style.display = 'block';
                    return;
                }

                renderRegisteredEvents(events);
                loadingSpinner.style.display = 'none';
                eventsContainer.style.display = 'grid';
            } catch (error) {
                loadingSpinner.style.display = 'none';
                showAlert('Failed to load registered events: ' + error.message, 'error');
            }
        }

        // Load user's created events
        async function loadCreatedEvents() {
            const loadingSpinner = document.getElementById('createdLoadingSpinner');
            const eventsContainer = document.getElementById('createdEventsContainer');
            const noEvents = document.getElementById('noCreatedEvents');

            try {
                loadingSpinner.style.display = 'block';
                eventsContainer.style.display = 'none';
                noEvents.style.display = 'none';

                // Mock API call - replace with actual API
                const events = await mockGetCreatedEvents();
                createdEvents = events;

                if (events.length === 0) {
                    loadingSpinner.style.display = 'none';
                    noEvents.style.display = 'block';
                    return;
                }

                renderCreatedEvents(events);
                loadingSpinner.style.display = 'none';
                eventsContainer.style.display = 'grid';
            } catch (error) {
                loadingSpinner.style.display = 'none';
                showAlert('Failed to load created events: ' + error.message, 'error');
            }
        }

        // Mock function for created events - replace with actual API
        async function mockGetCreatedEvents() {
            return [
                {
                    id: 101,
                    title: "Community Cleanup Day",
                    date: "2024-01-15T10:00:00",
                    location: "Central Park",
                    description: "Join us for a community cleanup event to make our neighborhood beautiful!",
                    attendees_count: 25
                }
            ];
        }

        // Render registered events
        function renderRegisteredEvents(events) {
            const container = document.getElementById('registeredEventsContainer');
            container.innerHTML = '';

            events.forEach(event => {
                const eventCard = createRegisteredEventCard(event);
                container.appendChild(eventCard);
            });
        }

        // Render created events
        function renderCreatedEvents(events) {
            const container = document.getElementById('createdEventsContainer');
            container.innerHTML = '';

            events.forEach(event => {
                const eventCard = createCreatedEventCard(event);
                container.appendChild(eventCard);
            });
        }

        // Create registered event card
        function createRegisteredEventCard(event) {
            const card = document.createElement('div');
            card.className = 'card';

            const eventDate = formatEventDate(event.date);
            const eventTime = new Date(event.date).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const isPastEvent = new Date(event.date) < new Date();

            card.innerHTML = `
                <div class="card-title">${escapeHtml(event.title)}</div>
                <div class="card-meta">
                    <div>ğŸ“… ${eventDate} at ${eventTime}</div>
                    <div>ğŸ“ ${escapeHtml(event.location)}</div>
                    ${isPastEvent ? '<div class="event-status past">Past Event</div>' : '<div class="event-status upcoming">Upcoming</div>'}
                </div>
                <div class="card-description">
                    ${escapeHtml(event.description)}
                </div>
                <div class="card-actions">
                    ${!isPastEvent ? `
                        <button class="btn btn-danger" onclick="cancelRegistration(${event.id})">
                            Cancel Registration
                        </button>
                    ` : ''}
                </div>
            `;

            return card;
        }

        // Create created event card
        function createCreatedEventCard(event) {
            const card = document.createElement('div');
            card.className = 'card';

            const eventDate = formatEventDate(event.date);
            const eventTime = new Date(event.date).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const isPastEvent = new Date(event.date) < new Date();

            card.innerHTML = `
                <div class="card-title">${escapeHtml(event.title)}</div>
                <div class="card-meta">
                    <div>ğŸ“… ${eventDate} at ${eventTime}</div>
                    <div>ğŸ“ ${escapeHtml(event.location)}</div>
                    <div>ğŸ‘¥ ${event.attendees_count || 0} attendees</div>
                    ${isPastEvent ? '<div class="event-status past">Past Event</div>' : '<div class="event-status upcoming">Upcoming</div>'}
                </div>
                <div class="card-description">
                    ${escapeHtml(event.description)}
                </div>
                <div class="card-actions">
                    <button class="btn btn-secondary" onclick="viewEventDetails(${event.id})">
                        View Details
                    </button>
                    ${!isPastEvent ? `
                        <button class="btn btn-primary" onclick="editEvent(${event.id})">
                            Edit Event
                        </button>
                    ` : ''}
                </div>
            `;

            return card;
        }

        // Cancel registration for an event
        async function cancelRegistration(eventId) {
            if (!confirm('Are you sure you want to cancel your registration for this event?')) {
                return;
            }

            try {
                await eventsAPI.unregister(eventId);
                showAlert('Registration cancelled successfully!', 'success');
                loadRegisteredEvents(); // Reload the list
            } catch (error) {
                showAlert('Failed to cancel registration: ' + error.message, 'error');
            }
        }

        // Filter registered events by status
        function filterRegisteredEvents() {
            const filter = document.getElementById('statusFilter').value;
            const now = new Date();

            let filteredEvents = registeredEvents;

            if (filter === 'upcoming') {
                filteredEvents = registeredEvents.filter(event => new Date(event.date) >= now);
            } else if (filter === 'past') {
                filteredEvents = registeredEvents.filter(event => new Date(event.date) < now);
            }

            renderRegisteredEvents(filteredEvents);
        }

        // View event details (placeholder)
        function viewEventDetails(eventId) {
            showAlert('Event details view coming soon!', 'info');
        }

        // Edit event (placeholder)
        function editEvent(eventId) {
            showAlert('Event editing coming soon!', 'info');
        }
    </script>
</body>
</html>
